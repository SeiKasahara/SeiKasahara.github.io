---
import { Icon } from "astro-icon/components";
import { languages, getLangFromUrl, getLocalizedUrl, useTranslations, type Lang } from "@/i18n";

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const currentPath = Astro.url.pathname;

// Language display info
const langDisplay: Record<Lang, { label: string; flag: string }> = {
  zh: { label: "ä¸­", flag: "ðŸ‡¨ðŸ‡³" },
  en: { label: "EN", flag: "ðŸ‡ºðŸ‡¸" },
  ja: { label: "æ—¥", flag: "ðŸ‡¯ðŸ‡µ" },
};
---

<div class="relative z-50" id="lang-switch-container">
  <button
    aria-label={t('lang.switch')}
    class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90"
    id="lang-switch"
  >
    <span class="text-sm font-bold">{langDisplay[currentLang].label}</span>
  </button>

  <div
    id="lang-panel"
    class="hidden lg:block absolute transition float-panel-closed top-11 -right-2 pt-5"
  >
    <div class="card-base float-panel p-2 min-w-[120px]">
      {Object.entries(languages).map(([lang, name]) => (
        <a
          href={getLocalizedUrl(currentPath, lang as Lang)}
          data-no-swup
          class:list={[
            "flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5",
            { "current-theme-btn": lang === currentLang },
          ]}
        >
          <span class="mr-2">{langDisplay[lang as Lang].flag}</span>
          {name}
        </a>
      ))}
    </div>
  </div>
</div>

<script>
  function initLangSwitch() {
    const container = document.getElementById("lang-switch-container");
    const button = document.getElementById("lang-switch");
    const panel = document.getElementById("lang-panel");

    if (!container || !button || !panel) return;

    let panelTimeout: number | null = null;

    function showPanel() {
      if (panelTimeout) {
        clearTimeout(panelTimeout);
        panelTimeout = null;
      }
      panel?.classList.remove("float-panel-closed");
    }

    function hidePanel() {
      if (panelTimeout) {
        clearTimeout(panelTimeout);
      }
      panelTimeout = window.setTimeout(() => {
        panel?.classList.add("float-panel-closed");
        panelTimeout = null;
      }, 150);
    }

    button.addEventListener("mouseenter", showPanel);
    container.addEventListener("mouseleave", hidePanel);

    // Toggle on click for touch devices
    button.addEventListener("click", () => {
      if (panel.classList.contains("float-panel-closed")) {
        showPanel();
      } else {
        hidePanel();
      }
    });

    // Save language preference when clicking a language link
    const langLinks = panel.querySelectorAll("a");
    langLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const href = link.getAttribute("href");
        if (href) {
          const lang = href.split("/")[1]; // Extract lang from /{lang}/...
          if (lang && ["zh", "en", "ja"].includes(lang)) {
            localStorage.setItem("preferredLang", lang);
          }
        }
      });
    });
  }

  // Initialize on page load
  initLangSwitch();

  // Re-initialize after swup page transitions
  document.addEventListener("swup:page:view", initLangSwitch);
</script>
