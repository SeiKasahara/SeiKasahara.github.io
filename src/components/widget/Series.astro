---
import { getSortedPosts } from '../../utils/content-utils'
import { getPostUrlBySlug } from '../../utils/url-utils'

interface Props {
  series: string
}

const { series } = Astro.props

// 获取所有文章并筛选出属于指定系列的文章
const allPosts = await getSortedPosts()
const seriesPosts = allPosts.filter(post => post.data.series === series)

// 按时间倒序排列（最新的在前）
const sortedSeriesPosts = [...seriesPosts].sort((a, b) => 
  new Date(b.data.published).getTime() - new Date(a.data.published).getTime()
)

// 设置折叠阈值
const COLLAPSE_THRESHOLD = 5
const isCollapsed = sortedSeriesPosts.length > COLLAPSE_THRESHOLD
---

<div class="card-base p-4">
  <div class="font-bold text-lg text-neutral-900 dark:text-neutral-100 relative mb-3
    before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
    before:absolute before:left-[-16px] before:top-[5.5px]">
    专栏：{series}
  </div>
  
  <div id="series-posts" class:list={["space-y-2", 
    {"overflow-hidden max-h-60": isCollapsed, "max-h-[10000px]": !isCollapsed}]}>
    {sortedSeriesPosts.map((post) => (
      <a href={getPostUrlBySlug(post.slug)} 
         class="block p-2 rounded hover:bg-[var(--btn-plain-bg-hover)] truncate">
        <div class="text-sm font-medium text-neutral-800 dark:text-neutral-200 truncate">
          {post.data.title}
        </div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">
          {post.data.published.toLocaleDateString('zh-CN')}
        </div>
      </a>
    ))}
  </div>
  
  {isCollapsed && (
    <div class="pt-2">
      <button id="expand-series-btn" class="btn-plain text-xs text-[var(--primary)]">
        展开 共 {sortedSeriesPosts.length} 篇文章
      </button>
    </div>
  )}
</div>

<script>
  // 添加展开功能
  function initExpandButton() {
    const expandBtn = document.getElementById('expand-series-btn')
    const content = document.getElementById('series-posts')
    
    if (expandBtn && content) {
      // 使用事件委托，避免重复绑定监听器
      const handleClick = function() {
        content.classList.remove('max-h-60')
        content.classList.add('max-h-[10000px]')
        expandBtn.classList.add('hidden')
        // 移除事件监听器，因为按钮已经隐藏不会再被点击
        expandBtn.removeEventListener('click', handleClick)
      }
      
      // 检查是否已经绑定了事件，避免重复绑定
      if (!expandBtn.dataset.listenerAdded) {
        expandBtn.addEventListener('click', handleClick)
        expandBtn.dataset.listenerAdded = 'true'
      }
    }
  }
  
  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExpandButton)
  } else {
    initExpandButton()
  }
  
  // 如果 swup 可用，也绑定到 swup 的页面视图事件
  if (window.swup) {
    window.swup.hooks.on('page:view', initExpandButton)
  }
</script>