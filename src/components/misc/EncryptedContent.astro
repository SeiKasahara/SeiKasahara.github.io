---
interface Props {
  encryptedContent: string;
  hint?: string;
}

const { encryptedContent, hint = "请输入密码查看加密内容" } = Astro.props;
---

<div class="encrypted-post" data-encrypted={encryptedContent}>
  <div class="password-form">
    <div class="lock-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    </div>
    <p class="hint">{hint}</p>
    <div class="input-group">
      <input
        type="password"
        class="post-password"
        placeholder="输入密码"
        autocomplete="off"
      />
      <button class="decrypt-btn" type="button">解密</button>
    </div>
    <p class="error-message" style="display: none;">密码错误，请重试</p>
  </div>
  <div class="decrypted-content" style="display: none;"></div>
</div>

<script>
import CryptoJS from 'crypto-js';

document.addEventListener('DOMContentLoaded', () => {
  const containers = document.querySelectorAll('.encrypted-post');

  containers.forEach(container => {
    const encryptedContent = container.getAttribute('data-encrypted');
    const passwordInput = container.querySelector('.post-password') as HTMLInputElement;
    const decryptBtn = container.querySelector('.decrypt-btn');
    const errorMsg = container.querySelector('.error-message') as HTMLElement;
    const decryptedDiv = container.querySelector('.decrypted-content') as HTMLElement;
    const passwordForm = container.querySelector('.password-form') as HTMLElement;

    const decrypt = () => {
      const password = passwordInput.value;
      if (!password) return;

      try {
        const bytes = CryptoJS.AES.decrypt(encryptedContent || '', password);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);

        if (decrypted) {
          decryptedDiv.innerHTML = decrypted;
          decryptedDiv.style.display = 'block';
          passwordForm.style.display = 'none';
          errorMsg.style.display = 'none';
        } else {
          throw new Error('Decryption failed');
        }
      } catch (e) {
        errorMsg.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    };

    decryptBtn?.addEventListener('click', decrypt);
    passwordInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        decrypt();
      }
    });
  });
});
</script>

<style>
.encrypted-post {
  margin: 2rem 0;
}

.password-form {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 3rem 2rem;
  background: var(--card-bg);
  border-radius: 1rem;
  border: 1px dashed var(--line-divider);
}

.lock-icon {
  color: var(--primary);
  margin-bottom: 1rem;
  opacity: 0.8;
}

.hint {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
  font-size: 0.95rem;
}

.input-group {
  display: flex;
  gap: 0.5rem;
  width: 100%;
  max-width: 320px;
}

.post-password {
  flex: 1;
  padding: 0.75rem 1rem;
  border: 1px solid var(--line-divider);
  border-radius: 0.5rem;
  background: var(--card-bg);
  color: var(--text-main);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s;
}

.post-password:focus {
  border-color: var(--primary);
}

.decrypt-btn {
  padding: 0.75rem 1.5rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  transition: opacity 0.2s;
}

.decrypt-btn:hover {
  opacity: 0.9;
}

.error-message {
  color: #ef4444;
  margin-top: 1rem;
  font-size: 0.875rem;
}

.decrypted-content {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
